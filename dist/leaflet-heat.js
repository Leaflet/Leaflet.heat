"use strict";function simpleheat(t){if(!(this instanceof simpleheat))return new simpleheat(t);this._canvas=t="string"==typeof t?document.getElementById(t):t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._max=1,this._data=[]}"undefined"!=typeof module&&(module.exports=simpleheat),simpleheat.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._ctx.clearRect(0,0,this._width,this._height),this._data=[],this},radius:function(t,i){i=void 0===i?15:i;var a=this._circle=this._createCanvas(),s=a.getContext("2d"),e=this._r=t+i;return a.width=a.height=2*e,s.shadowOffsetX=s.shadowOffsetY=2*e,s.shadowBlur=i,s.shadowColor="black",s.beginPath(),s.arc(-e,-e,t,0,2*Math.PI,!0),s.closePath(),s.fill(),this},resize:function(){this._width=this._canvas.width,this._height=this._canvas.height},gradient:function(t){var i,a=this._createCanvas(),s=a.getContext("2d"),e=s.createLinearGradient(0,0,0,256);for(i in a.width=1,a.height=256,t)e.addColorStop(+i,t[i]);return s.fillStyle=e,s.fillRect(0,0,1,256),this._grad=s.getImageData(0,0,1,256).data,this},draw:function(t,i){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var a=this._ctx;a.clearRect(0,0,this._width,this._height);for(var s,e=0,h=this._data.length;e<h;e++)s=this._data[e],a.globalAlpha=Math.min(Math.max(s[2]/this._max,void 0===t?.05:t),1),a.drawImage(this._circle,s[0]-this._r,s[1]-this._r);var n=a.getImageData(0,0,this._width,this._height);return this._colorize(n.data,this._grad,i),a.putImageData(n,0,0),this},_colorize:function(t,i,a){for(var s,e=0,h=t.length;e<h;e+=4)(s=4*t[e+3])&&(t[e]=i[s],t[e+1]=i[1+s],t[e+2]=i[2+s],a&&(t[e+3]=t[e+3]*a))},_createCanvas:function(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}},L.HeatLayer=(L.Layer||L.Class).extend({initialize:function(t,i){this._latlngs=t,L.setOptions(this,i)},setLatLngs:function(t){return this._latlngs=t,this.redraw()},addLatLng:function(t){return this._latlngs.push(t),this.redraw()},setOptions:function(t){return L.setOptions(this,t),this._heat&&this._updateOptions(),this.redraw()},redraw:function(){return this._heat&&!this._frame&&this._map&&!this._map._animating&&(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),(this.options.pane?this.getPane():t._panes.overlayPane).appendChild(this._canvas),t.on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){(this.options.pane?this.getPane():t.getPanes().overlayPane).removeChild(this._canvas),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),i=L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","msTransformOrigin"]),i=(t.style[i]="50% 50%",this._map.getSize()),i=(t.width=i.x,t.height=i.y,this._map.options.zoomAnimation&&L.Browser.any3d);L.DomUtil.addClass(t,"leaflet-zoom-"+(i?"animated":"hide")),this._heat=simpleheat(t),this._updateOptions()},_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur),this.options.gradient&&this._heat.gradient(this.options.gradient),this.options.max&&this._heat.max(this.options.max)},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]),t=(L.DomUtil.setPosition(this._canvas,t),this._map.getSize());this._heat._width!==t.x&&(this._canvas.width=this._heat._width=t.x),this._heat._height!==t.y&&(this._canvas.height=this._heat._height=t.y),this._redraw()},_redraw:function(){if(this._map){var t=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom,i=void 0===this.options.minZoom?this._map.getMinZoom():this.options.minZoom,a=this._map.getZoom();if(t<a||a<i)this._heat.clear();else{for(var s,e,h,n=[],t=this._heat._r,a=this._map.getSize(),o=new L.Bounds(L.point([-t,-t]),a.add([t,t])),r=void 0===this.options.max?1:this.options.max,i=void 0===this.options.maxIntensityZoom?this._map.getMaxZoom():this.options.maxIntensityZoom,_=1/Math.pow(2,Math.max(0,Math.min(i-this._map.getZoom(),12))),m=t/2,d=[],a=this._map._getMapPanePos(),l=a.x%m,c=a.y%m,p=0,u=this._latlngs.length;p<u;p++){var f,g,v,w=this._map.latLngToContainerPoint(this._latlngs[p]);o.contains(w)&&(f=Math.floor((w.x-l)/m)+2,g=Math.floor((w.y-c)/m)+2,v=(void 0!==this._latlngs[p].alt?this._latlngs[p].alt:void 0!==this._latlngs[p][2]?+this._latlngs[p][2]:1)*_,d[g]=d[g]||[],(s=d[g][f])?(s[0]=(s[0]*s[2]+w.x*v)/(s[2]+v),s[1]=(s[1]*s[2]+w.y*v)/(s[2]+v),s[2]+=v):d[g][f]=[w.x,w.y,v])}for(p=0,u=d.length;p<u;p++)if(d[p])for(e=0,h=d[p].length;e<h;e++)(s=d[p][e])&&n.push([Math.round(s[0]),Math.round(s[1]),Math.min(s[2],r)]);this._heat.data(n).draw(this.options.minOpacity,this.options.alpha),this._frame=null}}},_animateZoom:function(t){var i=this._map.getZoomScale(t.zoom),t=this._map._getCenterOffset(t.center)._multiplyBy(-i).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,t,i):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(t)+" scale("+i+")"}}),L.heatLayer=function(t,i){return new L.HeatLayer(t,i)};